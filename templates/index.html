<!DOCTYPE html>
<html>
<head>
    <title>Porcupine Test</title>
</head>
<body>
<h2>Porcupine Wake Word Test</h2>
<button onclick="startMic()">Start Mic</button>
<div id="status"></div>

<script>
let ws;
async function startMic() {
    ws = new WebSocket("ws://" + location.host + "/ws");
    ws.onmessage = (event) => {
        if(event.data === "TRIGGER"){
            document.getElementById("status").innerText = "Wake word detected!";
        }
    };

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const audioCtx = new AudioContext({ sampleRate: 16000 });
    const source = audioCtx.createMediaStreamSource(stream);
    const processor = audioCtx.createScriptProcessor(512, 1, 1);

    source.connect(processor);
    processor.connect(audioCtx.destination);

    processor.onaudioprocess = (e) => {
        const input = e.inputBuffer.getChannelData(0);
        const int16Buffer = new Int16Array(input.length);
        for(let i=0;i<input.length;i++){
            let s = Math.max(-1, Math.min(1, input[i]));
            int16Buffer[i] = s < 0 ? s*0x8000 : s*0x7FFF;
        }
        ws.send(int16Buffer.buffer);
    };
}
</script>
</body>
</html>
